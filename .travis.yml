---
services: docker

env:
  - distro: centos7
  - distro: ubuntu1604

before_install:
  - export repo=$DOCKERHUB_USERNAME/docker-$distro-ansible
  - export container_id=$(date +%s)
  - |
    if [ $distro = 'ubuntu1604' ]; then
      export init="/lib/systemd/systemd"
    fi
  - export init="/usr/lib/systemd/systemd"
  - export opts="--privileged --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro"
  
script:
  # Download image
  - docker pull $repo
  
  # Run container
  - docker run -d -v="$PWD":/etc/ansible/roles/role_to_test:rw --name $container_id $opts $repo $init
  
  # Run lints.
  - docker exec -t $container_id ansible-playbook /etc/ansible/roles/role_to_test/tests/test.yml --syntax-check
  - docker exec -t $container_id ansible-lint /etc/ansible/roles/role_to_test/*/*.yml
  
  # Run playbook.  
  - docker exec $container_id env ANSIBLE_FORCE_COLOR=1 ansible-playbook /etc/ansible/roles/role_to_test/tests/test.yml
  
  # Run idempotence check
  - idempotence=$(mktemp)
  - docker exec $container_id env ANSIBLE_FORCE_COLOR=1 ansible-playbook /etc/ansible/roles/role_to_test/tests/test.yml | tee -a $idempotence
  - |
    tail $idempotence | grep -q 'changed=0.*failed=0' \
    && (printf 'Idempotence test: pass \n') \
    || (printf 'Idempotence test: fail \n' && exit 1)

  # Run java check
  - docker exec -t $container_id java -version
